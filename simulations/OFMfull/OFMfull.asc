Version 4
SHEET 1 1380 1152
WIRE 528 272 432 272
WIRE 528 304 448 304
WIRE 992 304 752 304
WIRE 1024 304 992 304
WIRE 528 336 464 336
WIRE 208 432 160 432
WIRE 432 432 432 272
WIRE 432 432 208 432
WIRE -608 448 -688 448
WIRE -400 448 -400 432
WIRE -400 448 -432 448
WIRE -368 448 -400 448
WIRE 208 464 160 464
WIRE 432 464 208 464
WIRE -688 496 -688 448
WIRE 432 544 432 464
WIRE 528 544 432 544
WIRE 48 576 -128 576
WIRE 448 576 448 304
WIRE 448 576 48 576
WIRE 528 576 448 576
WIRE 992 576 752 576
WIRE 1024 576 992 576
WIRE -688 608 -688 576
WIRE 400 608 336 608
WIRE 464 608 464 336
WIRE 464 608 400 608
WIRE 528 608 464 608
WIRE -128 640 -128 576
WIRE 128 656 64 656
WIRE 336 656 336 608
WIRE 336 656 304 656
WIRE 64 704 64 656
WIRE -128 736 -128 720
WIRE 64 816 64 784
FLAG -400 432 current_setpoint
FLAG 400 608 UBias
FLAG 48 576 Switch
FLAG 992 304 IADC
FLAG 992 576 UADC
FLAG -128 736 0
FLAG 208 432 Imeas
FLAG 208 464 Umeas
FLAG -688 608 0
FLAG -688 448 IPWM
FLAG 64 816 0
SYMBOL current_source -112 448 R0
SYMATTR InstName X1
SYMBOL BiasGainAmplifier 640 304 R0
SYMATTR InstName X2
SYMBOL BiasGainAmplifier 640 576 R0
SYMATTR InstName X3
SYMBOL voltage -128 624 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName Vswitch
SYMATTR Value {Uswitch}
SYMBOL voltage -688 480 R0
WINDOW 3 39 42 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V3
SYMATTR Value PULSE(0 3.3 0 1n 1n {Ton_I} {Tperiod})
SYMBOL pwm_filter_v1 -528 448 R0
SYMATTR InstName X4
SYMBOL voltage 64 688 R0
WINDOW 3 39 42 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V4
SYMATTR Value PULSE(0 3.3 0 1n 1n {Ton_B} {Tperiod})
SYMBOL pwm_filter_v1 208 656 R0
SYMATTR InstName X5
TEXT -280 264 Left 2 !.tran 0 30ms 20ms startup uic\n;.op\n.TEMP=30
TEXT -640 624 Left 2 !.options gmin=1e-10\n.options abstol=1e-10\n.options reltol=0.003\n.options chgtol=1e-14\n.options trtol=1\n.options sstol=0.001\n.options MinDeltaGmin=0.0001\n \n.options srcsteps=0
TEXT -1312 32 Left 2 !* calculate PWM frequency\n* MasterClock Frequency = 54MHz\n.param FCLK={54Meg}\n \n* ARR = 10bit = 1024\n* ARR = 12bit = 4096\n.param ARR = {4096}\n \n* Prescaler\n.param PSC ={0}\n \n * calculate PWM frequency\n.param FPWM =  { FCLK / ( (ARR + 1) * (PSC + 1) ) }\n.param Tperiod = { 1 / FPWM }\n \n* PWM  timer setting\n.param CCR_I = 2048\n.param CCR_B = 2048\n \n * calculate DutyCycle\n.param DutyCycle_I = { CCR_I / ARR }\n.param DutyCycle_B = { CCR_B / ARR }\n \n* calculate Pulse Parameters\n.param Ton_I ={DutyCycle_I / FPWM}\n.param Ton_B={DutyCycle_B / FPWM}
TEXT -640 920 Left 2 !.step param Uswitch list 0 3.3
