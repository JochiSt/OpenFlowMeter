Version 4
SHEET 1 1380 1152
WIRE 528 272 432 272
WIRE 528 304 448 304
WIRE 992 304 752 304
WIRE 1024 304 992 304
WIRE 528 336 464 336
WIRE 208 432 160 432
WIRE 432 432 432 272
WIRE 432 432 208 432
WIRE -608 448 -688 448
WIRE -400 448 -400 432
WIRE -400 448 -432 448
WIRE -368 448 -400 448
WIRE 208 464 160 464
WIRE 432 464 208 464
WIRE -688 496 -688 448
WIRE 432 544 432 464
WIRE 528 544 432 544
WIRE 48 576 -208 576
WIRE 448 576 448 304
WIRE 448 576 48 576
WIRE 528 576 448 576
WIRE 992 576 752 576
WIRE 1024 576 992 576
WIRE -688 608 -688 576
WIRE 32 608 -16 608
WIRE 464 608 464 336
WIRE 464 608 32 608
WIRE 528 608 464 608
WIRE -208 640 -208 576
WIRE -16 640 -16 608
WIRE -208 736 -208 720
WIRE -16 736 -16 720
FLAG -400 432 current_setpoint
FLAG 32 608 UBias
FLAG 48 576 Switch
FLAG 992 304 IADC
FLAG 992 576 UADC
FLAG -208 736 0
FLAG -16 736 0
FLAG 208 432 Imeas
FLAG 208 464 Umeas
FLAG -688 608 0
FLAG -688 448 IPWM
SYMBOL current_source -112 448 R0
SYMATTR InstName X1
SYMBOL BiasGainAmplifier 640 304 R0
SYMATTR InstName X2
SYMBOL BiasGainAmplifier 640 576 R0
SYMATTR InstName X3
SYMBOL voltage -16 624 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value 1.5
SYMBOL voltage -208 624 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V2
SYMATTR Value 3.3
SYMBOL voltage -688 480 R0
WINDOW 3 39 42 Left 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V3
SYMATTR Value PULSE(0 3.3 0 1n 1n {Ton} {Tperiod})
SYMBOL pwm_filter_v1 -528 448 R0
SYMATTR InstName X4
TEXT -128 88 Left 2 !.tran 0 30ms 20ms\n;.op\n.TEMP=30
TEXT -128 192 Left 2 !.options gmin=1e-9\n.options abstol=1e-6\n.options reltol=0.01\n.options cshunt=1e-15
TEXT -1168 48 Left 2 !* calculate PWM frequency\n* MasterClock Frequency = 54MHz\n.param FCLK={54Meg}\n* PWM  timer setting\n.param CCR = 2048\n* ARR = 10bit = 1024\n* ARR = 12bit = 4096\n.param ARR = {4096}\n* Prescaler\n.param PSC ={0}\n * calculate PWM frequency\n.param FPWM = {FCLK / ( (ARR + 1) * (PSC + 1) )}\n * calculate DutyCycle\n.param DutyCycle = { CCR / ARR }\n* calculate Pulse Parameters\n.param Ton={DutyCycle / FPWM}\n.param Tperiod={ 1 / FPWM }
